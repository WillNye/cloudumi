Resources:
  SpokeRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - !Ref CentralRoleArnParameter
            Action:
              - "sts:AssumeRole"
              - "sts:TagSession"
      RoleName: !Ref SpokeRoleNameParameter
      Policies:
        - PolicyName: "spoke-acct-policy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "config:BatchGet*" # Retrieve AWS Config details for your resources ; Will allow policy rollback
                  - "config:List*" # Retrieve information about AWS resources to list in a single source of truth
                  - "config:Select*" # Query AWS Config
                  - "ec2:describeregions" # Retrieve active regions for your AWS environment
                  - "iam:AddRoleToInstanceProfile" # Used when creating/cloning roles
                  - "iam:AttachRolePolicy"
                  - "iam:AttachUserPolicy"
                  - "iam:CreateInstanceProfile"
                  - "iam:CreateRole"
                  - "iam:DeleteAccessKey"
                  - "iam:DeleteInstanceProfile"
                  - "iam:DeleteRole"
                  - "iam:DeletePolicy"
                  - "iam:DeletePolicyVersion"
                  - "iam:DeleteRolePermissionsBoundary"
                  - "iam:DeleteRolePolicy"
                  - "iam:DeleteUser"
                  - "iam:DeleteUserPermissionsBoundary"
                  - "iam:DeleteUserPolicy"
                  - "iam:DeleteVirtualMFADevice"
                  - "iam:DetachRolePolicy"
                  - "iam:DetachUserPolicy"
                  - "iam:GenerateCredentialReport"
                  - "iam:GenerateOrganizationsAccessReport"
                  - "iam:GenerateServiceLastAccessedDetails"
                  - "iam:GetAccessKeyLastUsed"
                  - "iam:GetAccountAuthorizationDetails"
                  - "iam:GetAccountSummary"
                  - "iam:GetCredentialReport"
                  - "iam:GetGroup"
                  - "iam:GetGroupPolicy"
                  - "iam:GetInstanceProfile"
                  - "iam:GetPolicy"
                  - "iam:GetPolicyVersion"
                  - "iam:GetRole"
                  - "iam:GetRolePolicy"
                  - "iam:GetServiceLastAccessedDetails"
                  - "iam:GetServiceLastAccessedDetailsWithEntities"
                  - "iam:GetUser"
                  - "iam:GetUserPolicy"
                  - "iam:ListAccessKeys"
                  - "iam:ListAccountAliases"
                  - "iam:ListAttachedRolePolicies"
                  - "iam:ListAttachedUserPolicies"
                  - "iam:ListEntitiesForPolicy"
                  - "iam:ListGroupPolicies"
                  - "iam:ListGroups"
                  - "iam:ListGroupsForUser"
                  - "iam:ListInstanceProfileTags"
                  - "iam:ListInstanceProfiles"
                  - "iam:ListInstanceProfilesForRole"
                  - "iam:ListPolicies"
                  - "iam:ListPolicyTags"
                  - "iam:ListPolicyVersions"
                  - "iam:ListRolePolicies"
                  - "iam:ListRoleTags"
                  - "iam:ListRoles"
                  - "iam:ListUserPolicies"
                  - "iam:ListUserTags"
                  - "iam:ListUsers"
                  - "iam:PassRole"
                  - "iam:PutRolePermissionsBoundary"
                  - "iam:PutRolePolicy"
                  - "iam:PutUserPermissionsBoundary"
                  - "iam:PutUserPolicy"
                  - "iam:RemoveRoleFromInstanceProfile"
                  - "iam:RemoveUserFromGroup"
                  - "iam:SetDefaultPolicyVersion"
                  - "iam:SimulateCustomPolicy"
                  - "iam:SimulatePrincipalPolicy"
                  - "iam:TagInstanceProfile"
                  - "iam:TagPolicy"
                  - "iam:TagRole"
                  - "iam:TagUser"
                  - "iam:UntagInstanceProfile"
                  - "iam:UntagPolicy"
                  - "iam:UntagRole"
                  - "iam:UntagUser"
                  - "iam:UpdateAssumeRolePolicy"
                  - "iam:UpdateRole"
                  - "iam:UpdateRoleDescription"
                  - "iam:UpdateUser"
                  - "organizations:DescribeAccount"
                  - "organizations:DescribeEffectivePolicy"
                  - "organizations:DescribeOrganization"
                  - "organizations:DescribeOrganizationalUnit"
                  - "organizations:DescribePolicy"
                  - "organizations:ListAccounts"
                  - "organizations:ListAccountsForParent"
                  - "organizations:ListChildren"
                  - "organizations:ListCreateAccountStatus"
                  - "organizations:ListDelegatedAdministrators"
                  - "organizations:ListDelegatedServicesForAccount"
                  - "organizations:ListHandshakesForAccount"
                  - "organizations:ListHandshakesForOrganization"
                  - "organizations:ListOrganizationalUnitsForParent"
                  - "organizations:ListParents"
                  - "organizations:ListPolicies"
                  - "organizations:ListPoliciesForTarget"
                  - "organizations:ListRoots"
                  - "organizations:ListTagsForResource"
                  - "organizations:ListTargetsForPolicy"
                  - "organizations:TagResource"
                  - "organizations:UntagResource"
                  - "s3:GetBucketLocation"
                  - "s3:GetBucketPolicy" # Retrieve information about your S3 buckets ; Enable modifying buckets
                  - "s3:GetBucketTagging"
                  - "s3:ListAllMyBuckets"
                  - "s3:ListBucket"
                  - "s3:PutBucketPolicy"
                  - "s3:PutBucketTagging"
                  - "sns:GetTopicAttributes" # Retrieve information about your SNS topics ; Enable modifying topics
                  - "sns:ListTagsForResource"
                  - "sns:ListTopics"
                  - "sns:SetTopicAttributes"
                  - "sns:TagResource"
                  - "sns:UnTagResource"
                  - "sqs:GetQueueAttributes" # Retrieve information about your SQS queues ; Enable modifying queues
                  - "sqs:GetQueueUrl"
                  - "sqs:ListQueues"
                  - "sqs:ListQueueTags"
                  - "sqs:SetQueueAttributes"
                  - "sqs:TagQueue"
                  - "sqs:UntagQueue"
                Resource: "*"
  SnsCustomResource:
    Type: "Custom::SnsCustomResource"
    DependsOn: "SpokeRole"
    Properties:
      ServiceToken: !Ref RegistrationTopicArnParameter
      IntegrationName: !Ref "AWS::StackName"
      Host: !Ref HostParameter
      ActionType: "AWSSpokeAcctRegistration"
      TemplateVersion: 1.5
      AWSAccountId: !Ref "AWS::AccountId"
      CentralRoleArn: !Ref CentralRoleArnParameter
      SpokeRoleName: !Ref SpokeRoleNameParameter
      ExternalId: !Ref ExternalIDParameter

Parameters:
  CentralRoleArnParameter:
    Description: >-
      The cross account role in customer's environment that will be allowed to assume this spoke role account.
    Type: String
    MinLength: "2"
    MaxLength: "100"
    AllowedPattern: '^arn:aws:iam::\d{12}:role/.+'
    ConstraintDescription: 'Invalid CentralRoleArn value.  Must match pattern ^arn:aws:iam::\d{12}:role/.+'
  ExternalIDParameter:
    Description: >-
      ExternalId is used for verification.
    Type: String
    MinLength: "2"
    MaxLength: "100"
    AllowedPattern: '[\w+=,.@:\/-]*'
    ConstraintDescription: 'Invalid ExternalID value.  Must match pattern [\w+=,.@:\/-]*'
  HostParameter:
    Description: >-
      The host parameter. Do not change this value!
    Type: String
    MinLength: "2"
    MaxLength: "100"
    AllowedPattern: '[\w+_-]*'
    ConstraintDescription: 'Invalid Host value.  Must match pattern [\w+_-]*'
  SpokeRoleNameParameter:
    Description: >-
      The name of the spoke role in each customer account. Do not change this value!
    Type: String
    MinLength: "2"
    MaxLength: "100"
    AllowedPattern: '[\w+_-]*'
    ConstraintDescription: 'Invalid SpokeRoleName value.  Must match pattern [\w+_-]*'
  RegistrationTopicArnParameter:
    Description: >-
      The SNS queue ARN that will be used to send registration messages to the SaaS
    Type: String
    MinLength: "2"
    MaxLength: "100"
    AllowedPattern: '^arn:aws:sns:[\w-]*:\d{12}:.+'
    ConstraintDescription: 'Invalid RegistrationTopicArn value.  Must match pattern ^arn:aws:sns:[\w-]*:\d{12}:.+'
Outputs:
  CentralRoleArn:
    Description: The central role in the customer's environment that will be allowed to assume the created spoke role.
    Value: !Ref CentralRoleArnParameter
  ExternalID:
    Description: ExternalID to share with the SaaS for verification
    Value: !Ref ExternalIDParameter
  Host:
    Description: Host to share with the SaaS provider for deployment
    Value: !Ref HostParameter
  SpokeRoleName:
    Description: The name of the spoke role in each customer account.
    Value: !Ref SpokeRoleNameParameter
  RegistrationTopicArnParameter:
    Description: SNS Registration queue ARN
    Value: !Ref RegistrationTopicArnParameter
